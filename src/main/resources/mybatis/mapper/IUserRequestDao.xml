<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ex.tjspring.study.dao.IUserRequestDao">

    <resultMap id="UserRequestDtoMap" type="com.ex.tjspring.study.dto.UserRequestDto">
        <id property="id" column="id"/>
        <result property="userId" column="USER_ID"/>
        <result property="studyPostId" column="STUDY_POST_ID"/>
        <result property="requestedAt" column="REQUESTED_AT"/>
        <result property="applicationStatus" column="APPLICATION_STATUS"/>
        <result property="applicationMessage" column="APPLICATION_MESSAGE"/>
        <result property="processedAt" column="PROCESSED_AT"/>
        <result property="processedBy" column="PROCESSED_BY"/>
        <result property="rejectionReason" column="REJECTION_REASON"/>
        <result property="groupId" column="GROUP_ID"/>
    </resultMap>

    <!-- ResultMap 정의 -->
    <resultMap id="GroupDtoResultMap" type="com.ex.tjspring.study.dto.GroupDto">
        <id property="groupId" column="GROUP_ID"/>
        <result property="groupName" column="GROUP_NAME"/>
        <result property="category" column="CATEGORY"/>
        <result property="maxMembers" column="MAX_MEMBERS"/>
        <result property="studyMode" column="STUDY_MODE"/>
        <result property="region" column="REGION"/>
        <result property="contact" column="CONTACT"/>
        <result property="groupIntroduction" column="GROUP_INTRODUCTION"/>
        <result property="groupOwnerId" column="GROUP_OWNER_ID"/>
        <result property="createdAt" column="CREATED_AT"/>
        <result property="thumbnail" column="THUMBNAIL"/>
        <result property="membershipStatus" column="MEMBERSHIP_STATUS"/>
        <result property="nickname" column="NICKNAME"/>
    </resultMap>

    <!-- ## 스터디 그룹 STUDY_MEMBERSHIP , USER_REQUEST 유무 확인 o -->
    <select id="checkUserStatusForApplication" resultType="int">
        SELECT
            COUNT(*)
        FROM DUAL
        WHERE NOT EXISTS (
              SELECT 1
              FROM STUDY_MEMBERSHIP
              WHERE group_id = #{groupId} AND user_id = #{userId}
              ) AND NOT EXISTS (
                    SELECT 1
                    FROM USER_REQUEST
                    WHERE study_post_id = #{studyPostId} AND user_id = #{userId}
                    )
    </select>

    <!-- ## 스터디 그룹 정보 가져오기 o -->
    <select id="selectStudyGroupFindByGroupId" parameterType="java.lang.Long" resultMap="GroupDtoResultMap">
        SELECT
            sg.GROUP_ID,
            sg.GROUP_NAME,
            sg.CATEGORY,
            sg.MAX_MEMBERS,
            sg.STUDY_MODE,
            sg.REGION,
            sg.CONTACT,
            sg.GROUP_INTRODUCTION,
            sg.THUMBNAIL,
            sg.GROUP_OWNER_ID,
            sg.CREATED_AT
        FROM STUDY_GROUPS sg
        WHERE sg.GROUP_ID = #{groupId}
    </select>

    <!-- ## 스터디 그룹 가입요청 등록 o -->
    <insert id="insertUserRequest" parameterType="com.ex.tjspring.study.dto.UserRequestDto">
        INSERT INTO USER_REQUEST (user_id, study_post_id, requested_at, application_status, application_message, processed_at, processed_by, rejection_reason )
        VALUES (#{userId}, #{studyPostId}, SYSTIMESTAMP , #{applicationStatus} ,  #{applicationMessage} , null , null , null )
    </insert>

    <!-- 스터디 GROUP_ID로 신청 리스트 가져오기 - PENDING 만 가져오기 O -->
    <select id="selectUserRequestFindByGroupId" resultMap="UserRequestDtoMap">
        SELECT
            r.id,
            r.user_id,
            r.study_post_id,
            r.requested_at,
            r.application_status,
            r.application_message,
            r.processed_at,
            r.processed_by,
            r.rejection_reason,
            p.group_id,
            u.nickname,
            u.profile_image
        FROM USER_REQUEST r
        JOIN STUDY_POST p ON r.study_post_id = p.study_post_id
        JOIN USERS u ON r.user_id = u.id
        WHERE p.group_id = #{groupId}
        AND r.application_status = 'PENDING'
    </select>

    <!-- ID로 특정 가입요청 조회 O -->
    <select id="selectUserRequestById" parameterType="java.lang.Long" resultMap="UserRequestDtoMap">
        SELECT r.id,
        r.user_id,
        r.study_post_id,
        r.requested_at,
        r.application_status,
        r.application_message,
        r.processed_at,
        r.processed_by,
        r.rejection_reason,
        p.group_id,
        u.nickname,
        u.profile_image
        FROM USER_REQUEST r
        JOIN STUDY_POST p ON r.study_post_id = p.study_post_id
        JOIN USERS u ON r.user_id = u.id
        WHERE r.id = #{id}
    </select>

    <!-- 가입요청 승인/거절 처리 O -->
    <update id="processUserRequest" parameterType="map">
        UPDATE USER_REQUEST r
        SET
        r.application_status = #{status},
        r.processed_at = SYSDATE,
        r.processed_by = (
        SELECT sg.group_owner_id
        FROM STUDY_POST sp
        JOIN STUDY_GROUPS sg ON sp.group_id = sg.group_id
        WHERE sp.study_post_id = r.study_post_id
        AND ROWNUM = 1
        )
        WHERE r.id = #{requestId}
    </update>









    <!-- 스터디 홍보글 포스트 ID 로 가입신청한 갯수 -->
    <select id="existsUserRequestByPostId" parameterType="java.lang.Long" resultType="int">
        SELECT COUNT(*) FROM USER_REQUEST WHERE post_id = #{postId}
    </select>

    <!-- 스터디 홍보글 그룹 ID 로 가입신청한 갯수 -->
    <select id="existsUserRequestByGroupId" parameterType="java.lang.Long" resultType="int">
        SELECT COUNT(r.user_request_id)
        FROM USER_REQUEST r
        JOIN STUDY_POST p ON r.study_post_id = p.study_post_id
        WHERE p.group_id = #{groupId}
    </select>


    <!-- 가입요청 수정 -->
    <update id="updateUserRequest" parameterType="com.ex.tjspring.study.dto.UserRequestDto">
        UPDATE USER_REQUEST
        SET requested_at = #{requestedAt}, application_status = #{applicationStatus} , application_message = #{applicationMessage} , processed_at = #{processedAt} , processed_by = #{processedBy} , rejection_reason = #{rejectionReason}
        WHERE id = #{id}
    </update>

    <!-- 가입요청 삭제 -->
    <delete id="deleteUserRequest" parameterType="java.lang.Long">
        DELETE FROM USER_REQUEST
        WHERE id = #{id}
    </delete>

</mapper>
